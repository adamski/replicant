stages:
  - build
  - test
  - deploy

variables:
  CARGO_HOME: $CI_PROJECT_DIR/.cargo

cache:
  key:
    files:
      - Cargo.lock
    prefix: ${CI_COMMIT_REF_SLUG}-cargo
  paths:
    - .cargo/
    - target/
  policy: pull-push

.rust_setup: &rust_setup
  - apt-get update -qq && apt-get install -y -qq build-essential postgresql-client
  - curl https://sh.rustup.rs -sSf | sh -s -- -y
  - source $CARGO_HOME/env
  - rustc --version && cargo --version

build:
  stage: build
  before_script:
    - *rust_setup
  script:
    - cargo build --workspace --release
  artifacts:
    paths:
      - target/release/sync-server
    expire_in: 1 week

test:
  stage: test
  dependencies: []
  services:
    - postgres:16
  variables:
    POSTGRES_DB: sync_test_db
    POSTGRES_USER: postgres
    POSTGRES_PASSWORD: postgres
    DATABASE_URL: "postgres://postgres:postgres@postgres/sync_test_db"
    TEST_DATABASE_URL: "postgres://postgres:postgres@postgres/sync_test_db"
  before_script:
    - *rust_setup
    - cargo install sqlx-cli --no-default-features --features postgres
  script:
    - cd sync-server && sqlx migrate run && cd ..
    - cargo test --workspace --lib --bins -- --nocapture
    - cargo clippy --workspace -- -D clippy::correctness -D clippy::suspicious

docker:
  stage: deploy
  image: docker:latest
  services:
    - docker:dind
  script:
    - docker build -t sync-server .
  only:
    - main