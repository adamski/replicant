FROM rust:1.82

# Install dependencies
RUN apt-get update && apt-get install -y \
    postgresql-client \
    netcat-traditional \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Install sqlx-cli for migrations
RUN cargo install sqlx-cli --no-default-features --features postgres

WORKDIR /workspace

# Create a script to wait for services
RUN echo '#!/bin/bash\n\
until nc -z postgres-test 5432; do\n\
  echo "Waiting for postgres..."\n\
  sleep 1\n\
done\n\
until nc -z sync-server-test 8080; do\n\
  echo "Waiting for sync server..."\n\
  sleep 1\n\
done\n\
echo "All services ready!"' > /wait-for-services.sh && \
chmod +x /wait-for-services.sh

CMD ["/wait-for-services.sh"]